# API Endpoint Implementation Plan: POST /api/prds/{id}/questions/generate

## 1. Endpoint Overview
This endpoint is responsible for generating the next round of questions from an AI service for a specific Product Requirement Document (PRD). It is triggered after a new PRD is created or when a user submits their answers and chooses to continue the planning session. The endpoint orchestrates fetching the PRD's context, calling the AI, persisting the new questions, and returning them to the client.

## 2. Request Details
- **HTTP Method**: `POST`
- **URL Structure**: `/api/prds/{id}/questions/generate`
- **Parameters**:
  - **Path Parameter (Required)**: `id` (string, UUID) - The unique identifier of the PRD.
- **Request Body**: None.

## 3. Used Types
- **Response DTO**: `GeneratedPrdQuestionsDto` - Contains the array of newly generated questions.
  ```typescript
  export interface GeneratedPrdQuestionsDto {
    questions: PrdQuestionDto[];
  }
  ```
- **Entity DTO**: `PrdQuestionDto` - Represents a single question object.
  ```typescript
  export interface PrdQuestionDto {
    id: string;
    prdId: string;
    roundNumber: number;
    question: string;
    answer: string | null;
    createdAt: string;
  }
  ```

## 4. Response Details
- **Success (201 Created)**: Returns a `GeneratedPrdQuestionsDto` object containing the newly created questions for the next round.
  ```json
  {
    "questions": [
      {
        "id": "uuid-q3",
        "prdId": "uuid-prd1",
        "roundNumber": 2,
        "question": "A new question generated by the AI.",
        "answer": null,
        "createdAt": "iso_timestamp"
      }
    ]
  }
  ```
- **Error**: Returns a standard error response object with a relevant status code and message.
  ```json
  {
    "error": "Error message description"
  }
  ```

## 5. Data Flow
1. The client sends a `POST` request to `/api/prds/{id}/questions/generate`.
2. Astro's middleware authenticates the user session.
3. The API route handler validates the `id` path parameter to ensure it's a valid UUID.
4. The handler calls the `generateNextQuestions` method in `prdQuestion.service.ts`, passing the `prdId` and the Supabase client instance.
5. The service retrieves the PRD from the database, ensuring its status is `planning`.
6. The service fetches the complete question and answer history for the PRD.
7. It constructs a detailed prompt for the AI service, including PRD details and the conversation history.
8. The service makes an API call to the AI service (OpenRouter.ai) to get the next set of questions.
9. It parses the AI response and validates the structure of the generated questions.
10. The new questions are saved to the `prd_questions` table in the database with the incremented `round_number`.
11. The service returns the newly created questions as an array of `PrdQuestionDto`.
12. The API route handler formats the response into a `GeneratedPrdQuestionsDto` object and sends it back to the client with a `201 Created` status.

## 6. Security Considerations
- **Authentication**: All requests to this endpoint must be authenticated. The Astro middleware will verify the user's session token. (assume it's done)
- **Authorization**: RLS will verify that the `user_id` of the requested PRD matches the ID of the authenticated user. Assume it's done (RLS will be enabled later)
- **Input Validation**: The `id` path parameter will be strictly validated as a UUID using Zod to prevent malicious input.

## 7. Error Handling
The endpoint will handle the following error scenarios:
- **400 Bad Request**: If the `id` parameter is not a valid UUID.
- **409 Conflict**: If the PRD's status is not `planning`.
- **500 Internal Server Error**:
  - If the AI service API call fails or returns an invalid response.
  - If there is a database error during read or write operations.
  - For any other unexpected server-side exceptions.

## 8. Performance Considerations
- The primary performance bottleneck will be the latency of the external AI service. The implementation should use asynchronous operations (`async/await`) to handle the API call without blocking the server.
- The size of the payload sent to the AI service will grow with the conversation history. While this is necessary for context, it could impact performance and cost over many rounds.

## 9. Implementation Steps
1.  **Create API Route File**: Create the file `src/pages/api/prds/[id]/questions/generate.ts`.
2.  **Define Route Handler**: Implement the `POST` handler within the new file. `export const prerender = false;` must be set.
3.  **Input Validation**: Reuse schema that validates the `id` path parameter as a string in UUID format defined in `src/lib/validation/prds.ts`. Parse and validate the input at the beginning of the handler.
4.  **Implement Service Method**: In `src/lib/services/prdQuestion.service.ts`, create a new public method `generateNextQuestions(client: SupabaseClient, prdId: string): Promise<Result<PrdQuestionDto[], Error>>`.
5.  **Add Service Logic - Data Fetching**:
    - Inside `generateNextQuestions`, first query the `prds` table to get the document by `prdId`.
    - Check if the PRD exists. If not, return a `NotFoundError`.
    - Check if `prd.status` is `'planning'`. If not, return a `ConflictError`.
6.  **Add Service Logic - AI Interaction**:
    - Add a mocked service for now (will be implemented later)
7.  **Add Service Logic - Data Persistence**:
    - Parse the AI's response. It is expected to be a JSON array of strings.
    - For each generated question string, create a new `PrdQuestion` entity object, setting `prd_id`, `question`, and `round_number`.
    - Use the Supabase client to insert the new question records into the `prd_questions` table in a single transaction.
    - Map the newly inserted database records to `PrdQuestionDto` objects and return them.
8.  **Connect Handler to Service**:
    - In the API route handler, call the `generateNextQuestions` service method.
    - Handle the `Result` object from the service. On success, format the data into `GeneratedPrdQuestionsDto`.
    - On failure, map the custom error type (e.g., `NotFoundError`, `ConflictError`) to the appropriate HTTP status code (`404`, `409`) and return a JSON error response.
9.  **Update Type Definitions**: Ensure all necessary DTOs like `GeneratedPrdQuestionsDto` are defined in `src/types.ts`.
